name: CI Testes com Relatório HTML
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: windows-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Instalar .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restaurar dependências
        run: dotnet restore

      - name: Compilar solução
        run: dotnet build --configuration Debug
      - name: Rodar testes com cobertura
        run: |
          dotnet test Zitec.Tests.csproj --no-build --configuration Debug `
            /p:CollectCoverage=true `
            /p:CoverletOutput=TestResults/coverage.json `
            /p:CoverletOutputFormat=cobertura `
            /p:ExcludeByAttribute="GeneratedCodeAttribute"

      - name: Baixar ReportGenerator
        run: dotnet tool install --global dotnet-reportgenerator-globaltool

      - name: Adicionar ReportGenerator ao PATH
        run: echo "$env:USERPROFILE\.dotnet\tools" | Out-File -Append -Encoding ascii $env:GITHUB_PATH

      - name: Gerar relatório HTML
        run: reportgenerator -reports:TestResults/coverage.cobertura.xml -targetdir:TestResults/HtmlReport -reporttypes:Html

      - name: Upload do relatório HTML
        uses: actions/upload-artifact@v4
        with:
          name: Testes-Relatorio-HTML
          path: TestResults/HtmlReport